## Webpack4 官方案例解读

> 注：从webpack-demo-5开始为官方案列

### Aggressive Merging  高效合并
1. 通过内置插件AggressiveMergingPlugin实现
2. 原理：从不同合并代码组合中寻找最优组合，指标为组合转化比：improvement = (aSize + bSize) / abSize，很明显，越大说明此种组合最优
3. 核心源码(部分删减)
```js
  apply(compiler) {
    const options = this.options;
    const minSizeReduce = this.options.minSizeReduce || 1.5;

    compiler.hooks.thisCompilation.tap(
      "AggressiveMergingPlugin",
      compilation => {
        compilation.hooks.optimizeChunks.tap(
          {
            name: "AggressiveMergingPlugin",
            stage: STAGE_ADVANCED
          },
          chunks => {
            const chunkGraph = compilation.chunkGraph;
            /** @type {{a: Chunk, b: Chunk, improvement: number}[]} */
            let combinations = [];
            for (const a of chunks) {
              // if (a.canBeInitial()) continue;
              for (const b of chunks) {
                // if (b.canBeInitial()) continue;
                // if (b === a) break;
                // if (!chunkGraph.canChunksBeIntegrated(a, b)) {continue;}
                const aSize = chunkGraph.getChunkSize(b, {chunkOverhead: 0});
                const bSize = chunkGraph.getChunkSize(a, {chunkOverhead: 0});
                const abSize = chunkGraph.getIntegratedChunksSize(b, a, {chunkOverhead: 0});
                const improvement = (aSize + bSize) / abSize;
                combinations.push({a, b, improvement});
              }
            }

            combinations.sort((a, b) => {
              return b.improvement - a.improvement;
            });

            const pair = combinations[0];

            console.log('得到最终提高率最大的chunk', pair)

            if (!pair) return;
            if (pair.improvement < minSizeReduce) return;

            chunkGraph.integrateChunks(pair.b, pair.a);
            compilation.chunks.delete(pair.a);
            return true;
          }
        );
      }
    );
  }
```
4. production模式下，该内置插件会生效，默认的minSizeReduce值为1.5，当然我们也可以手动配置该插件
以下分别为开发模式下未配置该插件，开发模式下配置该插件，生产模式下打包后截图(注：生产模式下不止这一个内置插件起作用)
![开发模式下未配置该插件打包](C:\Users\Matthew\webpack-demos\webpack-demo-5\imgs\开发模式下未配置该插件.png)
![开发模式下配置该插件打包](C:\Users\Matthew\webpack-demos\webpack-demo-5\imgs\开发模式下配置该插件.png)
![生产模式下打包](C:\Users\Matthew\webpack-demos\webpack-demo-5\imgs\生产模式下.png)

### Chunk
### Code Split
### Code Splitting
### Coffee Script
### CommonJS
### DLL
### Externals
### Harmony
### HTTP2 Aggressive Splitting
### Hybrid Routing
### Loader
### Mixed
### Multi Compiler
### Multi Part Library
### Multiple Entry Points
### Require Context
### Require Resolve
### Scope Hoisting
### Side Effects
### Source Map
### Web Worker
### Requests
### Building an Example
